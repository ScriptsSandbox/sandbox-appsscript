<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sandbox Weekly Staff Calendar</title>
  <style>
    :root{
      --bg:#747678; --grid:#B6B1A9; --text:#F5F0E6; --accent:#00C6D7;
      --cell-bg: rgba(255,255,255,0.02); --dim: 0.35;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:1200px;margin:0 auto;padding:16px; opacity:0; transition:opacity .25s ease;}
    .wrap.ready{opacity:1;}
    h1{margin:0 0 8px 0;font-size:20px;font-weight:600;}
    .subtle{opacity:.85;font-size:12px;margin-bottom:12px;}

    .topbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .navbtn,.chip{border:1px solid var(--grid);color:var(--text);background:transparent;
      padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px;line-height:1;
      transition:box-shadow .15s, background .15s, color .15s, opacity .15s;}
    .navbtn[disabled]{opacity:.55;cursor:not-allowed}
    .navbtn.active,.chip.selected{background:var(--accent);color:#0c1b1c;border-color:var(--accent);}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 14px 0}
    .chip:hover,.navbtn:hover{box-shadow:0 0 0 2px rgba(0,0,0,.12) inset;}

    .status{font-size:12px;opacity:.85;margin-left:8px;min-height:1em}

    .calendar{display:grid;grid-template-columns:90px repeat(7,1fr);
      border-top:1px solid var(--grid);border-left:1px solid var(--grid)}
    .cell{border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);
      padding:6px 8px;min-height:46px;position:relative;background:var(--cell-bg);
      transition:filter .15s, opacity .15s, box-shadow .15s, outline .15s;}
    .cell.dim{opacity:var(--dim);}
    .cell.match{outline:2px solid var(--accent);
      box-shadow:0 0 14px rgba(0,198,215,.45) inset, 0 0 6px rgba(0,198,215,.25)}
    .header{background:rgba(255,255,255,.04);font-weight:600;text-align:center}
    .time{background:rgba(255,255,255,.04);font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center}
    .names{font-size:12px;font-weight:600}
    .meta{font-size:11px;opacity:.85;margin-top:2px}
    .skills{margin-top:4px;font-size:10px;opacity:.8}

    /* Mobile list */
    @media(max-width:840px){
      .calendar{display:none}
      .mobile{display:block}
      .day-card{border:1px solid var(--grid);border-radius:10px;padding:8px;margin-bottom:12px;background:rgba(255,255,255,.03)}
      .day-title{font-weight:700;margin-bottom:6px}
      .slot{display:flex;gap:8px;padding:6px 0;border-top:1px solid var(--grid)}
      .slot:first-of-type{border-top:0}
      .slot-time{min-width:60px;font-weight:600;font-size:12px}
      .slot-body{font-size:12px}
    }
    @media(min-width:841px){ .mobile{display:none} }

    /* Loading overlay */
    .loading{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:var(--bg); z-index:999; transition:opacity .2s ease; opacity:1;
    }
    .loading.hidden{opacity:0; pointer-events:none;}
    .spinner{
      width:40px; height:40px; border-radius:50%;
      border:3px solid rgba(255,255,255,.25);
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
      margin-bottom:10px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loadbox{display:flex; flex-direction:column; align-items:center; gap:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

    .error{border:1px solid rgba(255,0,0,.5); background:rgba(255,0,0,.08); color:#fff; padding:8px 10px; border-radius:8px; font-size:12px; margin:8px 0;}
  </style>
</head>
<body>
  <div id="loading" class="loading" role="status" aria-live="polite" aria-label="Loading schedule">
    <div class="loadbox">
      <div class="spinner" aria-hidden="true"></div>
      <div>Loading schedule…</div>
      <div class="sr-only">Please wait while we load the weekly schedule.</div>
    </div>
  </div>

  <div id="app" class="wrap" aria-busy="true">
    <h1>Sandbox Staff — Weekly Schedule</h1>
    <div class="subtle">Filter by skill, and switch between <strong>This Week</strong> and <strong>Next Week</strong>.</div>

    <div class="topbar">
      <button id="btnThis" class="navbtn">This Week</button>
      <button id="btnNext" class="navbtn">Next Week</button>
      <div id="status" class="status" aria-live="polite"></div>
      <div style="flex:1"></div>
      <div id="chips" class="chips" role="toolbar" aria-label="Skill filters"></div>
    </div>

    <div id="err" class="error" style="display:none"></div>

    <div id="cal" class="calendar" aria-label="Weekly calendar grid"></div>
    <div id="mob" class="mobile" aria-label="Weekly schedule list"></div>
  </div>

  <script>
    const INIT_OFFSET = parseInt('<?= INIT_OFFSET ?>', 10) || 0;
    let DATA = null;
    let selectedSkill = null;
    const CACHE = {};

    const app = document.getElementById('app');
    const loader = document.getElementById('loading');
    const statusEl = document.getElementById('status');
    const errEl = document.getElementById('err');
    const btnThis = document.getElementById('btnThis');
    const btnNext = document.getElementById('btnNext');

    btnThis.onclick = () => setWeek(0);
    btnNext.onclick = () => setWeek(1);

    function setLoading(blocking){
      if (blocking){ loader.classList.remove('hidden'); app.setAttribute('aria-busy','true'); }
      else { loader.classList.add('hidden'); app.setAttribute('aria-busy','false'); app.classList.add('ready'); }
    }
    function setWorking(text){ statusEl.textContent = text || ''; }
    function setButtonsDisabled(disabled){ btnThis.disabled = disabled; btnNext.disabled = disabled; }
    function showError(msg){ errEl.textContent = msg || 'Something went wrong loading the schedule.'; errEl.style.display='block'; }
    function clearError(){ errEl.style.display='none'; errEl.textContent=''; }

    function setWeek(offset){
      offset = Math.max(0, Math.min(1, offset|0));
      clearError();

      if (CACHE[offset]) {
        DATA = CACHE[offset];
        renderAll();
        updateHighlight();
        btnThis.classList.toggle('active', offset===0);
        btnNext.classList.toggle('active', offset===1);
        setWorking('Updating…');
      } else {
        setButtonsDisabled(true);
        setLoading(true);
      }

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(d => {
            CACHE[offset] = d;
            DATA = d;
            renderAll();
            updateHighlight();
            btnThis.classList.toggle('active', offset===0);
            btnNext.classList.toggle('active', offset===1);
            setButtonsDisabled(false);
            setWorking('');
            setLoading(false);
          })
          .withFailureHandler(e => {
            setButtonsDisabled(false);
            setWorking('');
            setLoading(false);
            showError('Could not load schedule. Try again.');
          })
          .getCalendarData(offset);
      } else {
        const url = new URL(window.location.href);
        url.searchParams.set('offset', String(offset));
        window.location.replace(url.toString());
      }
    }

    function renderAll(){
      buildChips(DATA.skills || []);
      buildCalendar(DATA.dayLabels, DATA.hourLabels, DATA.grid);
      buildMobile(DATA.dayLabels, DATA.hourLabels, DATA.grid);
    }

    function buildChips(skills) {
      const el = document.getElementById('chips');
      el.innerHTML = '';
      skills.forEach(name => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.type = 'button';
        b.textContent = name;
        if (selectedSkill === name) b.classList.add('selected');
        b.addEventListener('click', () => {
          const already = selectedSkill === name;
          selectedSkill = already ? null : name;
          for (const c of el.querySelectorAll('.chip')) c.classList.remove('selected');
          if (!already) b.classList.add('selected');
          updateHighlight();
        });
        el.appendChild(b);
      });
      const reset = document.createElement('button');
      reset.className = 'chip';
      reset.textContent = 'Reset filter';
      reset.onclick = () => { selectedSkill = null; updateHighlight(); for (const c of el.querySelectorAll('.chip')) c.classList.remove('selected'); };
      el.appendChild(reset);
    }

    function buildCalendar(dayLabels, hourLabels, grid) {
      const cal = document.getElementById('cal');
      cal.innerHTML = '';
      cal.appendChild(cell('', 'header'));
      dayLabels.forEach(lbl => cal.appendChild(cell(lbl, 'header')));
      for (let r=0; r<hourLabels.length; r++) {
        cal.appendChild(cell(hourLabels[r], 'time'));
        for (let d=0; d<7; d++) {
          cal.appendChild(dayCell(grid[r][d]));
        }
      }
    }

    function buildMobile(dayLabels, hourLabels, grid) {
      const mob = document.getElementById('mob');
      mob.innerHTML = '';
      for (let d=0; d<7; d++) {
        const card = document.createElement('div'); card.className='day-card';
        const title = document.createElement('div'); title.className='day-title'; title.textContent = dayLabels[d];
        card.appendChild(title);
        for (let r=0; r<hourLabels.length; r++) {
          const slot = document.createElement('div'); slot.className='slot';
          const t = document.createElement('div'); t.className='slot-time'; t.textContent = hourLabels[r];
          const body = document.createElement('div'); body.className='slot-body';
          body.appendChild(buildCellInner(grid[r][d]));
          slot.appendChild(t); slot.appendChild(body);
          card.appendChild(slot);
        }
        mob.appendChild(card);
      }
    }

    function cell(text, className) {
      const div = document.createElement('div');
      div.className = 'cell ' + (className||'');
      if (text) div.textContent = text;
      return div;
    }
    function dayCell(c) {
      const div = document.createElement('div');
      div.className = 'cell';
      div.dataset.skills = (c.skills||[]).join('|');
      div.appendChild(buildCellInner(c));
      return div;
    }
    function buildCellInner(c) {
      const frag = document.createDocumentFragment();
      const names = document.createElement('div'); names.className='names';
      names.textContent = (c.staff||[]).map(s=>s.name).join(' • ') || '';
      const meta = document.createElement('div'); meta.className='meta';
      meta.textContent = (c.staff||[]).map(s=>s.location).filter(Boolean)[0] || '';
      const skills = document.createElement('div'); skills.className='skills';
      skills.textContent = (c.skills||[]).join(', ');
      frag.appendChild(names); frag.appendChild(meta); frag.appendChild(skills);
      return frag;
    }

    function updateHighlight() {
      // Desktop grid
      document.querySelectorAll('#cal .cell:not(.header):not(.time)').forEach(el => {
        if (!selectedSkill){ el.classList.remove('match','dim'); return; }
        const list = (el.dataset.skills||'').split('|').filter(Boolean);
        const matched = list.includes(selectedSkill);
        el.classList.toggle('match', matched);
        el.classList.toggle('dim', !matched);
      });
      // Mobile list
      document.querySelectorAll('#mob .slot').forEach(slot => {
        if (!selectedSkill){ slot.style.opacity='1'; slot.style.outline='none'; return; }
        const skillsEl = slot.querySelector('.skills');
        const list = skillsEl ? skillsEl.textContent.split(',').map(s=>s.trim()) : [];
        const matched = list.includes(selectedSkill);
        slot.style.opacity = matched ? '1' : getComputedStyle(document.documentElement).getPropertyValue('--dim') || '0.35';
        slot.style.outline = matched ? '2px solid var(--accent)' : 'none';
      });
    }

    // Boot
    (function init(){
      setLoading(true);
      setButtonsDisabled(true);
      setWeek(INIT_OFFSET);
    })();
  </script>
</body>
</html>