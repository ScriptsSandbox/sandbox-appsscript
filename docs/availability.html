<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sandbox Staff — Weekly Schedule</title>
  <style>
    :root{
      --bg:#6b7280;        /* page grey */
      --card:#1f2937;      /* dark panel */
      --text:#e5e7eb;      /* light text */
      --muted:#cbd5e1;
      --edge:#374151;
      --pill:#111827;
      --pillText:#f8fafc;
      --accent:#00C6D7;                /* selected-skill color */
      --coverA: rgba(255,255,255,.06); /* any coverage cell */
      --hitA:   rgba(0,198,215,.28);   /* selected-skill match cell */
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:1.5rem;margin:0 0 4px 0}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
    .btn{background:var(--pill);color:var(--pillText);border:1px solid var(--edge);
      padding:8px 12px;border-radius:999px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--text)}
    .btn.active{outline:2px solid var(--accent)}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
    .chip{background:#111827;color:#fff;border:1px solid var(--edge);padding:6px 10px;border-radius:999px;cursor:pointer;font-size:.85rem}
    .chip.active{background:var(--accent);color:#0b1220;border-color:transparent;box-shadow:0 0 0 2px var(--accent) inset, 0 0 0 1px var(--accent)}
    .chip.reset{background:transparent;color:var(--text)}
    .grid{width:100%;border-collapse:collapse;background:var(--card);border-radius:12px;overflow:hidden}
    .grid th,.grid td{border:1px solid var(--edge);padding:10px;vertical-align:top}
    .grid thead th{background:#2b3441;color:#fff;font-weight:600;text-align:left}
    .time{white-space:nowrap;width:110px}
    /* cells */
    .cell{min-height:54px;padding:6px 8px}
    .cell.cover{background:var(--coverA)}
    .cell.hit{background:var(--hitA); outline:2px solid var(--accent); outline-offset:-2px}
    .names{font-weight:600;font-size:.9rem;letter-spacing:.1px}
    .hdr{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap}
    .hdr small{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h1>Sandbox Staff — Weekly Schedule</h1>
    <small>Filter by skill; matching cells highlight. “This Week” / “Next Week” toggle.</small>
  </div>

  <div class="toolbar">
    <button id="btnThis" class="btn active">This Week</button>
    <button id="btnNext" class="btn ghost">Next Week</button>
  </div>
  <div class="chips" id="skillChips"></div>

  <table class="grid" id="grid">
    <thead><tr id="headRow"></tr></thead>
    <tbody id="bodyRows"></tbody>
  </table>
</div>

<script>
(async function(){
  const data = await fetch('./data/availability.json', {cache:'no-cache'}).then(r=>r.json());
  const tz = data.tz || 'America/Los_Angeles';
  const PEOPLE = data.people || [];
  const ALL_SKILLS = (data.skills && data.skills.length)
    ? data.skills
    : Array.from(new Set(PEOPLE.flatMap(p=>p.skills||[]))).sort((a,b)=>a.localeCompare(b));

  const els = {
    gridHead: document.getElementById('headRow'),
    gridBody: document.getElementById('bodyRows'),
    chips: document.getElementById('skillChips'),
    btnThis: document.getElementById('btnThis'),
    btnNext: document.getElementById('btnNext')
  };

  const HOURS = { start: 9, end: 17 };
  let weekOffsetDays = 0;
  let selectedSkill = '';

  const fmt = (d,opts)=> new Intl.DateTimeFormat('en-US',{timeZone:tz,...opts}).format(d);
  const nowTz = new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  function mondayOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  function buildDaySegments(){
    const byName = {};
    for(const p of PEOPLE){
      const segMap = {};
      for(const a of (p.available||[])){
        splitIntoDaysAndPush(segMap, a.start, a.end);
      }
      byName[p.name] = segMap;
    }
    return byName;
  }
  function splitIntoDaysAndPush(map, isoStart, isoEnd){
    const s = new Date(isoStart), e = new Date(isoEnd);
    let cur = new Date(s);
    while (true){
      const dayKey = dayKeyTz(cur);
      const startMin = minutesOfDayTz(cur);
      const nextDay = new Date(cur); nextDay.setDate(nextDay.getDate()+1); nextDay.setHours(0,0,0,0);
      const endForDay = (e <= nextDay) ? e : nextDay;
      const endMin = minutesOfDayTz(endForDay);
      pushSeg(map, dayKey, startMin, endMin);
      if (e <= nextDay) break;
      cur = nextDay;
    }
  }
  function pushSeg(map, key, a, b){
    if (!map[key]) map[key] = [];
    const start = Math.max(0, Math.min(24*60, a));
    const end   = Math.max(0, Math.min(24*60, b));
    if (end>start) map[key].push([start,end]);
  }
  function dayKeyTz(d){
    const y = fmt(d,{year:'numeric'}), m = fmt(d,{month:'2-digit'}), da = fmt(d,{day:'2-digit'});
    return `${y}-${m}-${da}`;
  }
  function minutesOfDayTz(d){
    const hh = parseInt(fmt(d,{hour:'2-digit',hour12:false}),10);
    const mm = parseInt(fmt(d,{minute:'2-digit'}),10);
    return hh*60+mm;
  }

  const PERSON_DAY_SEGS = buildDaySegments();

  function renderChips(){
    const chips = ['Reset filter', ...ALL_SKILLS];
    els.chips.innerHTML = chips.map((s,i)=>{
      const isReset = i===0;
      const active = isReset ? !selectedSkill : (selectedSkill===s);
      const cls = ['chip', isReset?'reset':'', active?'active':''].join(' ').trim();
      const pressed = active ? 'true' : 'false';
      return `<button class="${cls}" data-skill="${isReset?'':s}" aria-pressed="${pressed}">${s}</button>`;
    }).join('');
    els.chips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedSkill = btn.dataset.skill || '';
        renderGrid();
      });
    });
  }

  els.btnThis.addEventListener('click', ()=>{ weekOffsetDays=0; els.btnThis.classList.add('active'); els.btnNext.classList.remove('active'); renderGrid(); });
  els.btnNext.addEventListener('click', ()=>{ weekOffsetDays=7; els.btnNext.classList.add('active'); els.btnThis.classList.remove('active'); renderGrid(); });

  function renderGrid(){
    const mon = addDays(mondayOfWeek(nowTz), weekOffsetDays);
    els.gridHead.innerHTML = ['','Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((lbl,i)=>{
      if (i===0) return `<th class="time"></th>`;
      const d = addDays(mon, i-1);
      const title = fmt(d,{weekday:'short'}) + ' ' + fmt(d,{month:'numeric'}) + '/' + fmt(d,{day:'numeric'});
      return `<th>${title}</th>`;
    }).join('');

    const rowsHtml = [];
    for(let h=HOURS.start; h<=HOURS.end; h++){
      const rowCells = [];
      const label = formatHour(h);
      rowCells.push(`<td class="time">${label}</td>`);

      for(let di=0; di<7; di++){
        const d = addDays(mon, di);
        const dayKey = dayKeyTz(d);
        const slotStart = h*60, slotEnd = (h+1)*60;

        // who has coverage in this slot?
        const peopleInSlot = PEOPLE.filter(p=>{
          const segs = (PERSON_DAY_SEGS[p.name]||{})[dayKey]||[];
          return segs.some(([a,b]) => (a<slotEnd && b>slotStart));
        });

        // who matches the selected skill?
        const hits = selectedSkill
          ? peopleInSlot.filter(p => (p.skills||[]).includes(selectedSkill))
          : [];

        const hasCover = peopleInSlot.length > 0;
        const hasHit = hits.length > 0;

        // names to show (always show on-duty names)
        const displayNames = peopleInSlot.map(p=>p.name).join(' • ');
        const title = displayNames;

        const cls = ['cell', hasCover?'cover':'', hasHit?'hit':''].join(' ').trim();
        const inner = hasCover ? `<div class="names">${esc(displayNames)}</div>` : '';
        rowCells.push(`<td class="${cls}" title="${esc(title)}">${inner}</td>`);
      }
      rowsHtml.push(`<tr>${rowCells.join('')}</tr>`);
    }
    els.gridBody.innerHTML = rowsHtml.join('');

    try{
      const h = document.documentElement.scrollHeight;
      parent && parent.postMessage({type:'machines-grid-height', height:h}, '*');
    }catch(e){}
  }

  function formatHour(h24){
    const ampm = h24>=12 ? 'PM' : 'AM';
    const h = ((h24+11)%12)+1;
    return `${h}:00 ${ampm}`;
  }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  renderChips();
  renderGrid();
})();
</script>
</body>
</html>
