<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sandbox Staff — Weekly Schedule</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --page:#747678;     /* page bg */
      --card:#ffffff;     /* card bg (use #F5F0E6 if you want warmer) */
      --card-warm:#F5F0E6;
      --text:#14181f;
      --muted:#5b6573;
      --edge:#e5e7eb;

      --accent:#00C6D7;   /* cyan */
      --orange:#FC8900;   /* attention */
      --chip:#111827;

      --coverA: rgba(0,0,0,.04);          /* any coverage */
      --hitA:   rgba(0,198,215,.22);      /* selected-skill match */
    }

    html,body{
      margin:0; padding:0;
      background:var(--page); color:var(--text);
      font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}

    /* Header card (mimics your “open hours” card style) */
    .header-card{
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:20px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      padding:14px 16px;
      display:flex; align-items:center; gap:12px;
      margin-bottom:14px;
    }
    .cal-emoji{
      width:38px;height:38px; border-radius:12px;
      display:grid;place-items:center;
      background:var(--card-warm);
      border:1px solid var(--edge);
      font-size:20px;
    }
    .header-text h1{font-size:1.2rem; margin:0 0 2px 0; font-weight:700}
    .sub{color:var(--muted); font-size:.93rem}

    /* Controls row */
    .controls{
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:16px;
      box-shadow:0 8px 20px rgba(0,0,0,.04);
      padding:10px 12px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin-bottom:12px;
    }
    .seg{
      display:inline-flex; gap:6px; background:#fff; border:1px solid var(--edge);
      border-radius:999px; padding:4px;
    }
    .seg button{
      appearance:none; border:0; background:transparent; color:var(--text);
      padding:8px 14px; border-radius:999px; cursor:pointer; font-weight:600;
    }
    .seg button.active{
      background:var(--accent); color:#042226;
      box-shadow:0 0 0 2px var(--accent) inset;
    }

    .chips{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      appearance:none; border:1px solid var(--edge); background:#fff; color:#0b1220;
      padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    .chip.reset{color:var(--muted); background:#fff}
    .chip.active{
      background:var(--accent); color:#06262A; border-color:transparent;
      box-shadow:0 0 0 2px var(--accent) inset;
    }

    /* Grid table (rounded card look) */
    .grid{
      width:100%; border-collapse:separate; border-spacing:0;
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:20px; overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
    }
    .grid thead th{
      background:#f3f4f6; color:#0f172a; font-weight:700; text-align:left;
      padding:12px 12px; border-bottom:1px solid var(--edge);
    }
    .grid th, .grid td{border-right:1px solid var(--edge)}
    .grid th:last-child, .grid td:last-child{border-right:0}
    .time{white-space:nowrap; width:120px; font-weight:600; color:#263042}
    .grid tbody td{height:56px; padding:6px 10px}

    /* cells */
    .cell{border-top:1px solid var(--edge); border-bottom:1px solid var(--edge); border-right:1px solid var(--edge); border-left:0}
    .cell.cover{background:var(--coverA)}
    .cell.hit{background:var(--hitA); outline:2px solid var(--accent); outline-offset:-2px}
    .names{font-weight:600; letter-spacing:.15px}

    /* tiny status pill (optional, not used but ready) */
    .status{
      display:inline-flex; align-items:center; gap:8px; font-weight:600;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--orange);display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header card -->
    <div class="header-card">
      <div class="header-text">
        <h1>Sandbox Staff — Weekly Schedule</h1>
        <div class="sub">Filter by skill; matching cells highlight. Use “This Week / Next Week”.</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="seg" role="tablist" aria-label="Week switch">
        <button id="btnThis" class="active" role="tab" aria-selected="true">This Week</button>
        <button id="btnNext" class="" role="tab" aria-selected="false">Next Week</button>
      </div>
      <div class="chips" id="skillChips"></div>
    </div>

    <!-- Grid -->
    <table class="grid" id="grid" aria-label="Weekly staff availability">
      <thead><tr id="headRow"></tr></thead>
      <tbody id="bodyRows"></tbody>
    </table>
  </div>

<script>
(async function(){
  const data = await fetch('./data/availability.json', {cache:'no-cache'}).then(r=>r.json());
  const tz = data.tz || 'America/Los_Angeles';
  const PEOPLE = data.people || [];
  const ALL_SKILLS = (data.skills && data.skills.length)
    ? data.skills
    : Array.from(new Set(PEOPLE.flatMap(p=>p.skills||[]))).sort((a,b)=>a.localeCompare(b));

  const els = {
    gridHead: document.getElementById('headRow'),
    gridBody: document.getElementById('bodyRows'),
    chips: document.getElementById('skillChips'),
    btnThis: document.getElementById('btnThis'),
    btnNext: document.getElementById('btnNext')
  };

  const HOURS = { start: 9, end: 17 }; // 9–5 hourly slots
  let weekOffsetDays = 0;
  let selectedSkill = '';

  const fmt = (d,opts)=> new Intl.DateTimeFormat('en-US',{timeZone:tz,...opts}).format(d);
  const nowTz = new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  function mondayOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // Build per-person, per-day segments in minutes after midnight (in tz)
  function buildDaySegments(){
    const byName = {};
    for(const p of PEOPLE){
      const segMap = {};
      for(const a of (p.available||[])) splitIntoDaysAndPush(segMap, a.start, a.end);
      byName[p.name] = segMap; // { 'YYYY-MM-DD': [ [startMin,endMin], ... ] }
    }
    return byName;
  }
  function splitIntoDaysAndPush(map, isoStart, isoEnd){
    const s = new Date(isoStart), e = new Date(isoEnd);
    let cur = new Date(s);
    while (true){
      const key = dayKeyTz(cur);
      const startMin = minutesOfDayTz(cur);
      const nextDay = new Date(cur); nextDay.setDate(nextDay.getDate()+1); nextDay.setHours(0,0,0,0);
      const endForDay = (e <= nextDay) ? e : nextDay;
      const endMin = minutesOfDayTz(endForDay);
      pushSeg(map, key, startMin, endMin);
      if (e <= nextDay) break;
      cur = nextDay;
    }
  }
  function pushSeg(map, key, a, b){
    if (!map[key]) map[key] = [];
    const start = Math.max(0, Math.min(24*60, a));
    const end   = Math.max(0, Math.min(24*60, b));
    if (end>start) map[key].push([start,end]);
  }
  function dayKeyTz(d){
    const y = fmt(d,{year:'numeric'}), m = fmt(d,{month:'2-digit'}), da = fmt(d,{day:'2-digit'});
    return `${y}-${m}-${da}`;
  }
  function minutesOfDayTz(d){
    const hh = parseInt(fmt(d,{hour:'2-digit',hour12:false}),10);
    const mm = parseInt(fmt(d,{minute:'2-digit'}),10);
    return hh*60+mm;
  }

  const PERSON_DAY_SEGS = buildDaySegments();

  // Chips
  function renderChips(){
    const chips = ['Reset filter', ...ALL_SKILLS];
    els.chips.innerHTML = chips.map((s,i)=>{
      const isReset = i===0;
      const active = isReset ? !selectedSkill : (selectedSkill===s);
      const cls = ['chip', isReset?'reset':'', active?'active':''].join(' ').trim();
      return `<button class="${cls}" data-skill="${isReset?'':s}" aria-pressed="${active}">${s}</button>`;
    }).join('');
    els.chips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedSkill = btn.dataset.skill || '';
        renderGrid();
        // refresh chip states
        els.chips.querySelectorAll('.chip').forEach(b=>{
          const isReset = b.dataset.skill==="";
          b.classList.toggle('active', isReset ? !selectedSkill : (selectedSkill===b.dataset.skill));
          b.setAttribute('aria-pressed', isReset ? (!selectedSkill) : (selectedSkill===b.dataset.skill));
        });
      });
    });
  }

  // Week toggle
  els.btnThis.addEventListener('click', ()=>{
    weekOffsetDays=0; els.btnThis.classList.add('active'); els.btnNext.classList.remove('active'); renderGrid();
  });
  els.btnNext.addEventListener('click', ()=>{
    weekOffsetDays=7; els.btnNext.classList.add('active'); els.btnThis.classList.remove('active'); renderGrid();
  });

  // Grid
  function renderGrid(){
    const mon = addDays(mondayOfWeek(nowTz), weekOffsetDays);

    els.gridHead.innerHTML = ['','Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((lbl,i)=>{
      if (i===0) return `<th class="time"></th>`;
      const d = addDays(mon, i-1);
      const title = fmt(d,{weekday:'short'}) + ' ' + fmt(d,{month:'numeric'}) + '/' + fmt(d,{day:'numeric'});
      return `<th>${title}</th>`;
    }).join('');

    const rows = [];
    for(let h=HOURS.start; h<=HOURS.end; h++){
      const cells = [];
      cells.push(`<td class="time">${formatHour(h)}</td>`);

      for(let di=0; di<7; di++){
        const d = addDays(mon, di);
        const dayKey = dayKeyTz(d);
        const slotStart = h*60, slotEnd = (h+1)*60;

        // who’s on this hour?
        const peopleInSlot = PEOPLE.filter(p=>{
          const segs = (PERSON_DAY_SEGS[p.name]||{})[dayKey]||[];
          return segs.some(([a,b]) => (a<slotEnd && b>slotStart));
        });
        const hits = selectedSkill
          ? peopleInSlot.filter(p => (p.skills||[]).includes(selectedSkill))
          : [];

        const hasCover = peopleInSlot.length>0;
        const hasHit = hits.length>0;
        const displayNames = peopleInSlot.map(p=>p.name).join(' • ');

        const cls = ['cell', hasCover?'cover':'', hasHit?'hit':''].join(' ').trim();
        const inner = hasCover ? `<div class="names">${esc(displayNames)}</div>` : '';
        cells.push(`<td class="${cls}" title="${esc(displayNames)}">${inner}</td>`);
      }
      rows.push(`<tr>${cells.join('')}</tr>`);
    }
    els.gridBody.innerHTML = rows.join('');

    // auto-resize for iframe
    try{
      const h = document.documentElement.scrollHeight;
      parent && parent.postMessage({type:'machines-grid-height', height:h}, '*');
    }catch(e){}
  }

  function formatHour(h24){
    const ampm = h24>=12 ? 'PM' : 'AM';
    const h = ((h24+11)%12)+1;
    return `${h}:00 ${ampm}`;
  }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  renderChips();
  renderGrid();
})();
</script>
</body>
</html>
