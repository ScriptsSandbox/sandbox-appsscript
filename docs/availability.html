<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sandbox Staff — Weekly Schedule</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --page:#747678;      /* page bg */
      --card:#ffffff;      /* card bg */
      --text:#14181f;
      --muted:#5b6573;
      --edge:#e5e7eb;

      --accent:#00C6D7;
      --orange:#FC8900;

      --coverA: rgba(0,0,0,.04);     /* any coverage */
      --hitA:   rgba(0,198,215,.22); /* selected-skill match */

      --t: 400ms;                    /* transition duration */
      --e: ease;                     /* transition easing */
    }

    html,body{
      margin:0; padding:0;
      background:var(--page); color:var(--text);
      font:12px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; /* smaller */
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}

    /* Header card */
    .header-card{
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:20px;
      box-shadow:0 8px 20px rgba(0,0,0,.06);
      padding:12px 14px;
      display:flex; align-items:center; gap:12px;
      margin-bottom:12px;
    }
    .header-text h1{font-size:1rem; margin:0 0 2px 0; font-weight:700}
    .sub{color:var(--muted); font-size:.9rem}

    /* Controls row */
    .controls{
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:16px;
      box-shadow:0 8px 20px rgba(0,0,0,.04);
      padding:8px 10px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin-bottom:10px;
    }
    .seg{
      display:inline-flex; gap:6px; background:#fff; border:1px solid var(--edge);
      border-radius:999px; padding:3px;
    }
    .seg button{
      appearance:none; border:0; background:transparent; color:var(--text);
      padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:600;
      transition: background-color var(--t) var(--e), color var(--t) var(--e), box-shadow var(--t) var(--e);
    }
    .seg button.active{
      background:var(--accent); color:#042226;
      box-shadow:0 0 0 2px var(--accent) inset;
    }

    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      appearance:none; border:1px solid var(--edge); background:#fff; color:#0b1220;
      padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:400; /* non-bold */
      box-shadow:0 1px 0 rgba(0,0,0,.02);
      transition: background-color var(--t) var(--e), color var(--t) var(--e), box-shadow var(--t) var(--e);
    }
    .chip.reset{color:var(--muted); background:#fff}
    .chip.active{
      background:var(--accent); color:#06262A; border-color:transparent;
      box-shadow:0 0 0 2px var(--accent) inset;
    }

    /* Grid table */
    .grid{
      width:100%; border-collapse:separate; border-spacing:0;
      background:var(--card);
      border:1px solid var(--edge);
      border-radius:20px; overflow:hidden;
      box-shadow:0 10px 24px rgba(0,0,0,.06);
      transition: filter var(--t) var(--e), opacity var(--t) var(--e);
    }
    .grid thead th{
      background:#f3f4f6; color:#0f172a; font-weight:700; text-align:left;
      padding:10px; border-bottom:1px solid var(--edge);
      transition: color var(--t) var(--e), background-color var(--t) var(--e), opacity var(--t) var(--e), filter var(--t) var(--e);
    }
    .grid th, .grid td{border-right:1px solid var(--edge)}
    .grid th:last-child, .grid td:last-child{border-right:0}
    .time{white-space:nowrap; width:100px; font-weight:600; color:#263042}
    .grid tbody td{height:48px; padding:6px 8px}

    /* cells */
    .cell{
      border-top:1px solid var(--edge); border-bottom:1px solid var(--edge); border-right:1px solid var(--edge); border-left:0;
      transition: background-color var(--t) var(--e), outline-color var(--t) var(--e), opacity var(--t) var(--e), filter var(--t) var(--e);
      will-change: background-color, outline-color, opacity, filter;
    }
    .cell.cover{background:var(--coverA)}
    .cell.hit{background:var(--hitA); outline:2px solid var(--accent); outline-offset:-2px}
    .names{font-weight:400; letter-spacing:.1px} /* non-bold */

    /* When a filter is active, softly de-emphasize non-hit cells */
    .filtered .grid td.cell{ opacity:.78; filter: grayscale(10%); }
    .filtered .grid td.cell.hit{ opacity:1; filter:none; }
    .filtered .grid thead th{ opacity:.9; }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div class="header-card">
      <div class="header-text">
        <h1>Sandbox Staff — Weekly Schedule</h1>
        <div class="sub">Filter by skill; matching cells highlight. Use “This Week / Next Week”.</div>
      </div>
    </div>

    <div class="controls">
      <div class="seg" role="tablist" aria-label="Week switch">
        <button id="btnThis" class="active" role="tab" aria-selected="true">This Week</button>
        <button id="btnNext" class="" role="tab" aria-selected="false">Next Week</button>
      </div>
      <div class="chips" id="skillChips"></div>
    </div>

    <table class="grid" id="grid" aria-label="Weekly staff availability">
      <thead><tr id="headRow"></tr></thead>
      <tbody id="bodyRows"></tbody>
    </table>
  </div>

<script>
(async function(){
  const data = await fetch('./data/availability.json', {cache:'no-cache'}).then(r=>r.json());
  const tz = data.tz || 'America/Los_Angeles';
  const PEOPLE = data.people || [];
  const ALL_SKILLS = (data.skills && data.skills.length)
    ? data.skills
    : Array.from(new Set(PEOPLE.flatMap(p=>p.skills||[]))).sort((a,b)=>a.localeCompare(b));

  const els = {
    wrap: document.getElementById('wrap'),
    gridHead: document.getElementById('headRow'),
    gridBody: document.getElementById('bodyRows'),
    chips: document.getElementById('skillChips'),
    btnThis: document.getElementById('btnThis'),
    btnNext: document.getElementById('btnNext')
  };

  const HOURS = { start: 9, end: 17 }; // 9–5 hourly slots
  let weekOffsetDays = 0;
  let selectedSkill = '';

  const fmt = (d,opts)=> new Intl.DateTimeFormat('en-US',{timeZone:tz,...opts}).format(d);
  const nowTz = new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  function mondayOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  function buildDaySegments(){
    const byName = {};
    for(const p of PEOPLE){
      const segMap = {};
      for(const a of (p.available||[])) splitIntoDaysAndPush(segMap, a.start, a.end);
      byName[p.name] = segMap;
    }
    return byName;
  }
  function splitIntoDaysAndPush(map, isoStart, isoEnd){
    const s = new Date(isoStart), e = new Date(isoEnd);
    let cur = new Date(s);
    while (true){
      const key = dayKeyTz(cur);
      const startMin = minutesOfDayTz(cur);
      const nextDay = new Date(cur); nextDay.setDate(nextDay.getDate()+1); nextDay.setHours(0,0,0,0);
      const endForDay = (e <= nextDay) ? e : nextDay;
      const endMin = minutesOfDayTz(endForDay);
      pushSeg(map, key, startMin, endMin);
      if (e <= nextDay) break;
      cur = nextDay;
    }
  }
  function pushSeg(map, key, a, b){
    if (!map[key]) map[key] = [];
    const start = Math.max(0, Math.min(24*60, a));
    const end   = Math.max(0, Math.min(24*60, b));
    if (end>start) map[key].push([start,end]);
  }
  function dayKeyTz(d){
    const y = fmt(d,{year:'numeric'}), m = fmt(d,{month:'2-digit'}), da = fmt(d,{day:'2-digit'});
    return `${y}-${m}-${da}`;
  }
  function minutesOfDayTz(d){
    const hh = parseInt(fmt(d,{hour:'2-digit',hour12:false}),10);
    const mm = parseInt(fmt(d,{minute:'2-digit'}),10);
    return hh*60+mm;
  }

  const PERSON_DAY_SEGS = buildDaySegments();

  function renderChips(){
    const chips = ['Reset filter', ...ALL_SKILLS];
    els.chips.innerHTML = chips.map((s,i)=>{
      const isReset = i===0;
      const active = isReset ? !selectedSkill : (selectedSkill===s);
      const cls = ['chip', isReset?'reset':'', active?'active':''].join(' ').trim();
      return `<button class="${cls}" data-skill="${isReset?'':s}" aria-pressed="${active}">${s}</button>`;
    }).join('');
    els.chips.querySelectorAll('.chip').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedSkill = btn.dataset.skill || '';
        els.wrap.classList.toggle('filtered', !!selectedSkill); // dim non-hit cells
        applyFilterStyles();  // toggle classes in-place for smooth transitions
        // refresh chip states
        els.chips.querySelectorAll('.chip').forEach(b=>{
          const isReset = b.dataset.skill==="";
          const active  = isReset ? !selectedSkill : (selectedSkill===b.dataset.skill);
          b.classList.toggle('active', active);
          b.setAttribute('aria-pressed', String(active));
        });
      });
    });
  }

  els.btnThis.addEventListener('click', ()=>{
    weekOffsetDays=0; els.btnThis.classList.add('active'); els.btnNext.classList.remove('active'); renderGrid();
  });
  els.btnNext.addEventListener('click', ()=>{
    weekOffsetDays=7; els.btnNext.classList.add('active'); els.btnThis.classList.remove('active'); renderGrid();
  });

  function renderGrid(){
    const mon = addDays(mondayOfWeek(nowTz), weekOffsetDays);

    els.gridHead.innerHTML = ['','Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((lbl,i)=>{
      if (i===0) return `<th class="time"></th>`;
      const d = addDays(mon, i-1);
      const title = fmt(d,{weekday:'short'}) + ' ' + fmt(d,{month:'numeric'}) + '/' + fmt(d,{day:'numeric'});
      return `<th>${title}</th>`;
    }).join('');

    const rows = [];
    for(let h=HOURS.start; h<=HOURS.end; h++){
      const cells = [];
      cells.push(`<td class="time">${formatHour(h)}</td>`);

      for(let di=0; di<7; di++){
        const d = addDays(mon, di);
        const dayKey = dayKeyTz(d);
        const slotStart = h*60, slotEnd = (h+1)*60;

        const peopleInSlot = PEOPLE.filter(p=>{
          const segs = (PERSON_DAY_SEGS[p.name]||{})[dayKey]||[];
          return segs.some(([a,b]) => (a<slotEnd && b>slotStart));
        });

        const skillSet = Array.from(new Set(peopleInSlot.flatMap(p=>p.skills||[]))).sort((a,b)=>a.localeCompare(b));
        const hasCover = peopleInSlot.length>0;
        const names = peopleInSlot.map(p=>p.name).join(' • ');

        const classes = ['cell', hasCover?'cover':''];
        const td = `<td class="${classes.join(' ').trim()}" 
                        title="${esc(names)}"
                        data-cover="${hasCover?1:0}"
                        data-skills="${escAttr(skillSet.join('|'))}">
                      ${hasCover ? `<div class="names">${esc(names)}</div>` : ''}
                    </td>`;
        cells.push(td);
      }
      rows.push(`<tr>${cells.join('')}</tr>`);
    }
    els.gridBody.innerHTML = rows.join('');

    els.wrap.classList.toggle('filtered', !!selectedSkill);
    applyFilterStyles();

    try{
      const h = document.documentElement.scrollHeight;
      parent && parent.postMessage({type:'machines-grid-height', height:h}, '*');
    }catch(e){}
  }

  // Toggle .hit based on current selectedSkill using cell data attributes (so transitions animate)
  function applyFilterStyles(){
    const cells = els.gridBody.querySelectorAll('td.cell');
    cells.forEach(td=>{
      const hasCover = td.dataset.cover === '1';
      const skills = (td.dataset.skills || '').split('|').filter(Boolean);
      const hasHit = selectedSkill ? skills.includes(selectedSkill) : false;
      td.classList.toggle('hit', hasHit);
      td.classList.toggle('cover', hasCover);
    });
  }

  function formatHour(h24){
    const ampm = h24>=12 ? 'PM' : 'AM';
    const h = ((h24+11)%12)+1;
    return `${h}:00 ${ampm}`;
  }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escAttr(s){ return (s==null?'':String(s)).replace(/"/g,'&quot;'); }

  renderChips();
  renderGrid();
})();
</script>
</body>
</html>
